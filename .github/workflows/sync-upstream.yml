name: ðŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9:00 (UTC 1:00) è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: '0 1 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      conflict_strategy:
        description: 'å†²çªè§£å†³ç­–ç•¥'
        required: true
        default: 'theirs'
        type: choice
        options:
          - theirs  # é‡‡ç”¨ä¸Šæ¸¸ç‰ˆæœ¬
          - ours    # ä¿ç•™æˆ‘ä»¬çš„ç‰ˆæœ¬

jobs:
  sync:
    name: åŒæ­¥ä¸Šæ¸¸ä»£ç 
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”— æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          git remote add upstream https://github.com/QuantumNous/new-api.git || true
          git fetch upstream

      - name: ðŸ“Š æ£€æŸ¥æ›´æ–°
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "ðŸ“Š å½“å‰è½åŽä¸Šæ¸¸ $BEHIND ä¸ªæäº¤"

          if [ "$BEHIND" -eq 0 ]; then
            echo "âœ… å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            echo "need_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ éœ€è¦åŒæ­¥ $BEHIND ä¸ªæäº¤"
            echo "need_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”„ åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        if: steps.check.outputs.need_sync == 'true'
        run: |
          echo "ðŸš€ å¼€å§‹åˆå¹¶ä¸Šæ¸¸ä»£ç ..."

          # è®¾ç½®å†²çªè§£å†³ç­–ç•¥
          STRATEGY="${{ github.event.inputs.conflict_strategy || 'theirs' }}"
          echo "ðŸ“‹ å†²çªè§£å†³ç­–ç•¥: $STRATEGY"

          # å°è¯•è‡ªåŠ¨åˆå¹¶
          if git merge upstream/main --no-edit; then
            echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸï¼Œæ— å†²çª"
          else
            echo "âš ï¸ å‘çŽ°å†²çªï¼Œåº”ç”¨è§£å†³ç­–ç•¥: $STRATEGY"

            # èŽ·å–å†²çªæ–‡ä»¶åˆ—è¡¨
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            echo "ðŸ“ å†²çªæ–‡ä»¶:"
            echo "$CONFLICT_FILES"

            # è§£å†³å†²çª
            for file in $CONFLICT_FILES; do
              echo "ðŸ”§ è§£å†³å†²çª: $file"
              if [ "$STRATEGY" = "theirs" ]; then
                git checkout --theirs "$file"
              else
                git checkout --ours "$file"
              fi
              git add "$file"
            done

            # å®Œæˆåˆå¹¶
            git commit -m "ðŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸: è§£å†³å†²çª (ç­–ç•¥: $STRATEGY)

è‡ªåŠ¨åŒæ­¥æ¥è‡ª QuantumNous/new-api çš„æ›´æ–°
å†²çªè§£å†³ç­–ç•¥: $STRATEGY
å†²çªæ–‡ä»¶æ•°: $(echo "$CONFLICT_FILES" | wc -l)

ðŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"
          fi

      - name: ðŸ“¤ æŽ¨é€åˆ° fork ä»“åº“
        if: steps.check.outputs.need_sync == 'true'
        run: |
          echo "ðŸ“¤ æŽ¨é€æ›´æ–°åˆ° origin/main..."
          git push origin main
          echo "âœ… åŒæ­¥å®Œæˆï¼"

      - name: ðŸ“ ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: steps.check.outputs.need_sync == 'true'
        run: |
          echo "## ðŸ”„ åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æˆåŠŸåŒæ­¥ ${{ steps.check.outputs.behind }} ä¸ªæäº¤" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… åŒæ­¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ å†²çªç­–ç•¥: ${{ github.event.inputs.conflict_strategy || 'theirs' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€æ–°æäº¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: â„¹ï¸ æ— éœ€åŒæ­¥
        if: steps.check.outputs.need_sync == 'false'
        run: |
          echo "## âœ… ä»“åº“å·²æ˜¯æœ€æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å½“å‰åˆ†æ”¯å·²ä¸Žä¸Šæ¸¸åŒæ­¥ï¼Œæ— éœ€æ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
