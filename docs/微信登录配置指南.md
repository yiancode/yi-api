# 微信登录配置指南

## 概述

Yi-API 支持通过微信公众号实现用户登录和注册。该功能需要部署一个独立的 WeChat Server 服务来处理微信授权。

## 配置字段说明

在管理后台 **系统设置 → 配置 WeChat Server** 中，需要填写以下三个字段：

| 字段 | 说明 | 示例 |
|------|------|------|
| **WeChat Server 服务器地址** | 微信验证服务器的完整地址 | `https://wechat.example.com` |
| **WeChat Server 访问凭证** | 用于与 WeChat Server 通信的 Token/密钥 | `your-secret-token` |
| **微信公众号二维码图片链接** | 用户扫码关注的公众号二维码图片 URL | `https://example.com/qrcode.png` |

## 工作原理

Yi-API 的微信登录**不是直接对接微信开放平台**，而是通过一个中间服务 (WeChat Server) 来实现：

```
┌─────────┐    扫码关注     ┌─────────────┐
│  用户   │ ──────────────→ │ 微信公众号  │
└─────────┘                 └─────────────┘
     │                            │
     │ 输入验证码                  │ 发送验证码
     ↓                            ↓
┌─────────┐   验证 code    ┌─────────────┐
│ Yi-API  │ ──────────────→│WeChat Server│
└─────────┘                └─────────────┘
     │                            │
     │←── 返回 wechatId ──────────┘
     │
     ↓
  登录/注册成功
```

### 流程说明

1. 用户扫描公众号二维码，关注公众号
2. 用户向公众号发送消息，获取验证码
3. 用户在 Yi-API 登录页面输入验证码
4. Yi-API 调用 WeChat Server API 验证验证码
5. WeChat Server 返回用户的微信唯一标识 (wechatId)
6. Yi-API 根据 wechatId 进行登录或注册

## 部署 WeChat Server

### 方案一：使用 wechat-server 项目（推荐）

[wechat-server](https://github.com/JustSong/wechat-server) 是 One API 作者开发的配套服务，与 Yi-API 完全兼容。

#### Docker 部署

```bash
docker run -d \
  --name wechat-server \
  -p 3001:3000 \
  -e WECHAT_TOKEN=your_wechat_token \
  -e WECHAT_APPID=your_appid \
  -e WECHAT_SECRET=your_secret \
  -e API_TOKEN=your_api_token \
  justsong/wechat-server
```

#### 环境变量说明

| 变量 | 说明 |
|------|------|
| `WECHAT_TOKEN` | 微信公众号后台配置的 Token |
| `WECHAT_APPID` | 微信公众号 AppID |
| `WECHAT_SECRET` | 微信公众号 AppSecret |
| `API_TOKEN` | 对外提供 API 的访问凭证（填入 Yi-API 的 WeChat Server 访问凭证） |

### 方案二：自行实现

如果需要自行实现 WeChat Server，需要提供以下 API 接口：

```
GET /api/wechat/user?code={验证码}
Header: Authorization: {Token}

响应格式:
{
    "success": true,
    "message": "",
    "data": "微信用户唯一标识"  // openid 或 unionid
}

错误响应:
{
    "success": false,
    "message": "验证码错误或已过期",
    "data": ""
}
```

## 微信公众号配置

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **设置与开发 → 基本配置**
3. 配置服务器地址（URL）指向你的 WeChat Server
4. 设置 Token（与 WeChat Server 配置一致）
5. 选择消息加解密方式（建议选择明文模式或兼容模式）

## 在 Yi-API 中启用微信登录

### 步骤 1：配置 WeChat Server

在管理后台 **系统设置 → 配置 WeChat Server** 中填写：

- **WeChat Server 服务器地址**：你部署的 WeChat Server 地址
- **WeChat Server 访问凭证**：WeChat Server 的 API_TOKEN
- **微信公众号二维码图片链接**：公众号二维码图片 URL

点击 **保存 WeChat Server 设置**

### 步骤 2：启用微信登录

在管理后台 **系统设置 → 配置登录注册** 中，开启 **允许通过微信登录 & 注册** 选项。

## 常见问题

### Q: 验证码无效或已过期？

- 检查 WeChat Server 是否正常运行
- 确认验证码未超时（通常有效期 5 分钟）
- 确认 API Token 配置正确

### Q: 无法连接 WeChat Server？

- 检查服务器地址是否正确（注意 http/https）
- 检查网络连通性
- 检查 WeChat Server 日志

### Q: 微信公众号收不到消息？

- 确认公众号服务器配置已启用
- 确认 Token 配置正确
- 检查 WeChat Server 是否正确响应微信验证请求

## 相关文件

- 后端处理代码：`controller/wechat.go`
- 配置项定义：`common/constants.go`
- 前端配置界面：`web/src/components/settings/SystemSetting.jsx`
