# Yi-API 宝塔手动部署指南（OpenCloudOS）

> 适用于腾讯云轻量级服务器 + 宝塔面板 + MySQL 的手动部署方案

## 服务器要求

- 配置：2核4G内存，60G硬盘（足够）
- 系统：OpenCloudOS / CentOS / Ubuntu
- 面板：宝塔面板 9.x+

---

## 1. 安装 Go 环境（宝塔方式）

1. **宝塔面板 → Go项目 → SDK版本管理**

2. **点击 `1.25.5 (稳定版)` 右边的「安装」按钮**
   - 项目要求 Go 1.25+

3. **等待安装完成**（约 1-2 分钟）

4. **验证安装**：
   ```bash
   source /etc/profile
   go version
   # 应该输出: go version go1.25.5 linux/amd64
   ```

5. **配置 Go 代理**（加速依赖下载）：
   ```bash
   go env -w GOPROXY=https://goproxy.cn,direct
   ```

---

## 2. 在宝塔创建站点

1. **宝塔面板 → 网站 → 添加站点**
   - 域名：`your-domain.com`（替换为你的域名）
   - PHP版本：纯静态
   - 其他默认

2. **进入站点目录**：
   ```bash
   cd /www/wwwroot/your-domain.com
   ```

---

## 3. 在宝塔创建 MySQL 数据库

1. **宝塔面板 → 数据库 → 添加数据库**
   - 数据库名：`yi_api`
   - 用户名：`yi_api`
   - 密码：`你的密码`（记住这个密码）
   - 访问权限：**本地服务器**

2. **确保 MySQL 配置正确**（宝塔 → 数据库 → MySQL设置）：
   - 字符集：`utf8mb4`

3. **记录连接信息**：
   ```
   主机: 127.0.0.1
   端口: 3306
   用户: yi_api
   密码: 你设置的密码
   数据库: yi_api
   ```

---

## 4. 克隆项目并配置

```bash
# 进入站点目录
cd /www/wwwroot/your-domain.com

# 克隆项目到当前目录
git clone https://github.com/QuantumNous/new-api.git .

# 创建环境配置文件
cp .env.example .env
```

**编辑 `.env` 文件**：
```bash
nano .env
```

写入以下内容（根据实际情况修改）：
```bash
# 数据库配置（MySQL）
SQL_DSN=yi_api:你的密码@tcp(127.0.0.1:3306)/yi_api?charset=utf8mb4&parseTime=True&loc=Local

# 服务配置
PORT=3000
GIN_MODE=release
TZ=Asia/Shanghai

# 安全配置（生成随机字符串）
SESSION_SECRET=你的随机字符串32位以上
CRYPTO_SECRET=你的随机字符串32位以上

# 缓存配置（暂时用内存缓存，省资源）
MEMORY_CACHE_ENABLED=true

# 可选：如果宝塔有 Redis
# REDIS_CONN_STRING=redis://:密码@127.0.0.1:6379/0
```

**生成随机密钥**：
```bash
# 运行两次，分别用于 SESSION_SECRET 和 CRYPTO_SECRET
openssl rand -hex 32
openssl rand -hex 32
```

---

## 5. 构建项目

### 方案 A：服务器内存充足（≥4G 可用）

```bash
cd /www/wwwroot/your-domain.com

# 下载 Go 依赖
go mod download

# 构建前端
cd web
npm install  # 或 bun install
DISABLE_ESLINT_PLUGIN=true npm run build
cd ..

# 编译后端
go build -ldflags "-s -w" -o yi-api

# 验证编译成功
ls -lh yi-api
# 应该看到一个 30-50MB 的可执行文件
```

### 方案 B：服务器内存不足（本地构建前端）

如果服务器内存不足导致前端构建 OOM，在本地电脑构建后上传：

**本地执行**：
```bash
# 在本地项目目录构建前端
cd /你的本地项目路径/web
npm install
DISABLE_ESLINT_PLUGIN=true npm run build

# 打包 dist 目录
tar -czf dist.tar.gz dist

# 上传到服务器
scp dist.tar.gz root@你的服务器IP:/www/wwwroot/your-domain.com/web/
```

**服务器执行**：
```bash
cd /www/wwwroot/your-domain.com/web

# 解压前端构建产物
rm -rf dist
tar -xzf dist.tar.gz
rm dist.tar.gz

# 回到项目根目录编译后端
cd ..
go build -ldflags "-s -w" -o yi-api

# 验证
ls -lh yi-api
```

---

## 6. 在宝塔添加 Go 项目

> ⚠️ **前提**：必须先完成步骤 5 的编译，确保 `yi-api` 可执行文件已生成

1. **宝塔面板 → Go项目 → 添加Go项目**

2. **填写项目信息**：

   | 字段 | 填写方式 |
   |------|----------|
   | 项目执行文件 | 点击右侧文件夹图标 → 进入 `/www/wwwroot/your-domain.com/` → 选择 `yi-api` 文件 |
   | 项目名称 | `yi-api` |
   | 项目端口 | `3000` |
   | 执行命令 | 留空 |
   | 环境变量 | 选择 **从文件加载** |
   | 环境变量文件路径 | `/www/wwwroot/your-domain.com/.env` |
   | 运行用户 | `www` |
   | 开机启动 | ✅ 勾选 |
   | 绑定域名 | `your-domain.com` |

   **找不到 yi-api 文件？** 说明编译未完成，执行：
   ```bash
   cd /www/wwwroot/your-domain.com
   go build -ldflags "-s -w" -o yi-api
   ls -lh yi-api  # 确认文件存在且大小约 30-50MB
   ```

3. **点击「确定」创建项目**

4. **启动项目**：在项目列表中点击「启动」按钮

---

## 7. 配置反向代理（可选）

如果绑定域名后访问异常，配置反向代理：

1. **宝塔面板 → 网站 → your-domain.com → 反向代理**

2. **添加反向代理**：
   - 代理名称：`yi-api`
   - 目标URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`

3. **配置 WebSocket 支持**（用于实时 API）：

   点击站点 → 配置文件，在 `location /` 内添加：
   ```nginx
   proxy_http_version 1.1;
   proxy_set_header Upgrade $http_upgrade;
   proxy_set_header Connection "upgrade";
   proxy_read_timeout 300s;
   proxy_send_timeout 300s;
   ```

---

## 8. 配置 SSL（推荐）

1. **宝塔面板 → 网站 → your-domain.com → SSL**

2. **Let's Encrypt → 申请证书**

3. **开启「强制HTTPS」**

---

## 9. 验证部署

```bash
# 测试本地访问
curl http://127.0.0.1:3000/api/status

# 浏览器访问
# https://your-domain.com
```

**默认管理员账号**：
- 用户名：`root`
- 密码：`123456`

⚠️ **首次登录后请立即修改密码！**

---

## 10. 日常开发流程

### 服务器端更新

```bash
cd /www/wwwroot/your-domain.com

# 拉取最新代码
git pull

# 重新构建前端（如果前端有改动）
cd web && npm run build && cd ..

# 重新编译后端
go build -ldflags "-s -w" -o yi-api

# 在宝塔面板重启项目
# 宝塔 → Go项目 → yi-api → 重启
```

### 快捷部署脚本

```bash
# 创建部署脚本
cat > /www/wwwroot/your-domain.com/deploy.sh << 'EOF'
#!/bin/bash
cd /www/wwwroot/your-domain.com
git pull
cd web && npm run build && cd ..
go build -ldflags "-s -w" -o yi-api
echo "构建完成！请在宝塔面板重启 Go 项目"
EOF

chmod +x /www/wwwroot/your-domain.com/deploy.sh

# 以后更新只需运行
./deploy.sh
```

---

## 11. 本地开发连接远程数据库

如果你想在本地电脑开发，连接服务器的 MySQL：

1. **宝塔 → 数据库 → yi_api → 权限 → 改为"所有人"或指定IP**

2. **宝塔 → 安全 → 放行端口 3306**

3. **腾讯云控制台 → 防火墙 → 放行 3306 端口**

4. **本地 `.env` 配置**：
   ```bash
   SQL_DSN=yi_api:密码@tcp(服务器公网IP:3306)/yi_api?charset=utf8mb4&parseTime=True&loc=Local
   ```

5. **本地运行**：
   ```bash
   go run main.go
   ```

⚠️ **安全提示**：生产环境不建议对外开放 3306 端口，开发完记得改回"本地服务器"。

---

## 常用命令速查

```bash
# 宝塔 Go 项目管理
# 启动/停止/重启 → 在宝塔面板 Go项目 页面操作

# 查看项目日志
# 宝塔 → Go项目 → yi-api → 日志

# 构建命令
go build -ldflags "-s -w" -o yi-api   # 编译后端
cd web && npm run build               # 构建前端

# 开发模式（本地调试）
GIN_MODE=debug go run main.go         # 调试模式运行
cd web && npm run dev                 # 前端热更新
```

---

## 故障排查

### 1. 项目启动失败

- **宝塔 → Go项目 → yi-api → 日志** 查看错误信息
- 检查 `.env` 文件配置是否正确
- 检查数据库连接是否正常

### 2. 数据库连接失败
```bash
# 检查 MySQL 是否运行
systemctl status mysqld

# 测试连接
mysql -u yi_api -p -h 127.0.0.1 yi_api
```

### 3. 端口被占用
```bash
# 查看端口占用
lsof -i:3000
netstat -tlnp | grep 3000
```

### 4. 前端构建失败（内存不足）
```bash
# 增加 swap 空间
dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# 然后重新构建
cd web && npm run build
```

### 5. 权限问题
```bash
# 确保 www 用户有权限
chown -R www:www /www/wwwroot/your-domain.com
chmod +x /www/wwwroot/your-domain.com/yi-api
```

---

## 目录结构

```
/www/wwwroot/your-domain.com/
├── yi-api              # 编译后的可执行文件
├── .env                # 环境配置文件
├── main.go             # 程序入口
├── go.mod              # Go 依赖配置
├── web/                # 前端源码
│   └── dist/           # 前端构建产物
├── controller/         # 控制器
├── model/              # 数据模型
├── relay/              # 中继转发
├── router/             # 路由
├── service/            # 服务层
└── deploy.sh           # 部署脚本
```
